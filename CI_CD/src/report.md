## Part 1. Настройка gitlab-runner

Подними виртуальную машину Ubuntu Server 22.04 LTS.

![1.1](src/image/1.1.png)

Скачай и установи на виртуальную машину gitlab-runner.

    sudo curl -L --output /usr/local/bin/gitlab-runner "https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64"

    curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-ci-multi-runner/script.deb.sh | sudo bash

Запустить gitlab-runner и зарегистрировать его для использования в текущем проекте (DO6_CICD)

![1.2](src/image/1.2.png)

![1.3](src/image/1.3.png)

## Part 2. Сборка

Напиши этап для CI по сборке приложений из проекта C2_SimpleBashUtils.

В файле gitlab-ci.yml добавь этап запуска сборки через мейк файл из проекта C2.

![2.1](src/image/2.1.png)

## Part 3. Тест кодстайла

Напиши этап для CI, который запускает скрипт кодстайла (clang-format).

Если кодстайл не прошел, то «зафейли» пайплайн.

В пайплайне отобрази вывод утилиты clang-format.

![3.1](src/image/3.1.png)

## Part 4. Интеграционные тесты

Напиши этап для CI, который запускает твои интеграционные тесты из того же проекта.

Запусти этот этап автоматически только при условии, если сборка и тест кодстайла прошли успешно.

Если тесты не прошли, то «зафейли» пайплайн.

В пайплайне отобрази вывод, что интеграционные тесты успешно прошли / провалились.

![4.1](src/image/4.1.png)

![4.2](src/image/4.2.png)

## Part 5. Этап деплоя

Подними вторую виртуальную машину Ubuntu Server 22.04 LTS.

Установил вторую виртуальную машину Ubuntu Server 22.04 LTS и настроил сеть между ними

![5.1](src/image/5.1.png)

Cгенерировал и привязал SSH ключ 

    ssh-keygen
    
Написать этап для CD, который «разворачивает» проект на другой виртуальной машине

![5.2](src/image/5.2.png)

#### Настройка ssh-агента

Следующие изменения будут происходить от суперпользователя, поэтому сразу же перейдем в этот режим на машине с развернутым раннером


    sudo su
    
Перейдем в настройки раннера и обозначим ему где искать ssh-агента. Для этого в файле конфигураций добавим строку environment = ["SSH_AUTH_SOCK=/tmp/ssh-agent"]
    
    vim /etc/gitlab-runner/config.toml
    
![5.3](src/image/5.3.png)

Далее необходимо сохранить отпечаток удаленного сервера. Для этого ключ удаленного сервера необходимо добавить в файл known_hosts в домашнем каталоге пользователя gitlab-runner

    ssh-keyscan -H 192.10.10.2 >> /home/gitlab-runner/.ssh/known_hosts
    
![5.4](src/image/5.4.png)

Так как раннеру необходим приватный ключ, для того, чтобы не возникало проблем с ключами доступа к директории /home/arbokboe/.ssh и ее содержимому - скопируем закрытый ключ также в домашний каталог пользователя gitlab-runner

    cp /home/arbokboe/.ssh/id_rsa /home/gitlab-runner/.ssh/
    
    
В домашнем каталоге раннера есть все необходимое, однако на скрине можно заметить - так как мы находимся в режиме суперпользователя, в ключах указан root. Для того, чтобы раннер сумел их счесть, поменяем пользователя на gitlab-runner

    chown gitlab-runner:gitlab-runner id_rsa known_hosts 
       
![5.5](src/image/5.5.png)

Теперь с ключами доступа не должно возникнуть каких-либо проблем, дело осталось за малым. Режим суперпользователя нам более не необходим. Покидаем его зажатием комбинации Ctrl + D

  Скопируем содержимое нашего открытого ssh-ключа на удаленный сервер

    ssh-copy-id arbokboe@192.10.10.2
    
Теперь можно с уверенностью сказать, что этап деплоя не выдаст ошибок. Перезапустим службу раннера и тем самым закончим настройку ssh-агента

    sudo systemctl restart gitlab-runner.service

#### Проверка этапа деплоя

После пуша обновленного gitlab-ci.yml проверяем состояние пайплайна

![5.6](src/image/5.6.png)

Как видим этап deploy прошел успешно

## Part 6. Дополнительно. Уведомления

Настроить уведомления о успешном/неуспешном выполнении пайплайна через бота с именем «arbokboe DO6 CI/CD» в Telegram

Текст уведомления будет содержать информацию об успешности прохождения как этапа CI, так и этапа CD.
В остальном текст уведомления может быть произвольным.

Найдем в телеграме через поиск BotFather

Запустим бота и напишем /newbot

В диалоге необходимо будет написать:

имя бота arbokboe DO6 CI/CD» в Telegram

юзернейм для бота (имя должно быть уникальным и заканчиваться на bot)

![6.1](src/image/6.1.png)

В результате мы получили API бота. Теперь найдем бота getmyid_bot и напишем ему /start для получения нашего ID

![6.2](src/image/6.2.png)

Скрипт 

![6.3](src/image/6.3.png)

Результат

![6.4](src/image/6.4.png)
